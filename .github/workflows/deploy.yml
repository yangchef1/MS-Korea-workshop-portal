# =============================================================================
# Deploy Pipeline: infra → (backend ∥ frontend)
# =============================================================================
# infra must succeed (or be skipped) before app jobs run.
# backend and frontend run in parallel after infra.

name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy_infra:
        description: "Force deploy infrastructure"
        type: boolean
        default: false

permissions:
  id-token: write # OIDC
  contents: read
  packages: write # GHCR

env:
  AZURE_LOCATION: koreacentral
  GHCR_IMAGE: ghcr.io/${{ github.repository_owner }}/workshop-backend
  CONTAINER_APP_NAME: ${{ vars.CONTAINER_APP_NAME }}
  RESOURCE_GROUP: ${{ vars.RESOURCE_GROUP }}
  SWA_NAME: ${{ vars.SWA_NAME }}

# ---------------------------------------------------------------------------
# Job: Infrastructure (Bicep)
# ---------------------------------------------------------------------------
jobs:
  infra:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    if: >-
      github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_infra == 'true'
      || contains(github.event.head_commit.modified, 'infra/')
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }}
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy Bicep
        env:
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_SP_TENANT_ID: ${{ secrets.AZURE_SP_TENANT_ID }}
          AZURE_SP_CLIENT_ID: ${{ secrets.AZURE_SP_CLIENT_ID }}
          AZURE_SP_CLIENT_SECRET: ${{ secrets.AZURE_SP_CLIENT_SECRET }}
          AZURE_SP_DOMAIN: ${{ secrets.AZURE_SP_DOMAIN }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_ID: ${{ vars.VITE_AZURE_CLIENT_ID }}
          GHCR_IMAGE: ${{ env.GHCR_IMAGE }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          ACS_CONNECTION_STRING: ${{ secrets.ACS_CONNECTION_STRING }}
        run: |
          ENV_NAME=${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }}
          az deployment sub create \
            --location ${{ env.AZURE_LOCATION }} \
            --template-file infra/main.bicep \
            --parameters infra/parameters/${ENV_NAME}.bicepparam

  # ---------------------------------------------------------------------------
  # Job: Backend (Docker → GHCR → Container Apps)
  # ---------------------------------------------------------------------------
  backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: [infra]
    if: always() && !cancelled() && (needs.infra.result == 'success' || needs.infra.result == 'skipped')
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }}
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login to GHCR
        run: echo '${{ secrets.GITHUB_TOKEN }}' | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build & Push to GHCR
        run: |
          IMAGE=${{ env.GHCR_IMAGE }}:${{ github.sha }}
          docker build -t $IMAGE -f Dockerfile .
          docker push $IMAGE

      - name: Update Container App
        run: |
          az containerapp update \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.GHCR_IMAGE }}:${{ github.sha }}

  # ---------------------------------------------------------------------------
  # Job: Frontend (Build → SWA Deploy)
  # ---------------------------------------------------------------------------
  frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: [infra]
    if: always() && !cancelled() && (needs.infra.result == 'success' || needs.infra.result == 'skipped')
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install & Build
        working-directory: frontend
        env:
          VITE_AZURE_CLIENT_ID: ${{ vars.VITE_AZURE_CLIENT_ID }}
          VITE_AZURE_TENANT_ID: ${{ vars.VITE_AZURE_TENANT_ID }}
          VITE_AZURE_REDIRECT_URI: ${{ vars.VITE_AZURE_REDIRECT_URI }}
        run: |
          npm ci
          npm run build

      - name: Deploy to SWA
        uses: azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.SWA_DEPLOYMENT_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: upload
          app_location: frontend/dist
          skip_app_build: true
          skip_api_build: true
