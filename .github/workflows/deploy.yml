# =============================================================================
# Deploy Orchestrator
# =============================================================================
# Detects which directories changed and dispatches to reusable workflows.
#
# Flow:
#   detect-changes → deploy-infra → (deploy-backend ∥ deploy-frontend ∥ deploy-function)
#
# Branch → Environment mapping:
#   main → prod,  dev → dev
#
# Path → Component mapping:
#   infra/**           → infra  (+ triggers ALL other components)
#   backend/** | Dockerfile → backend
#   frontend/**        → frontend
#   function/**        → function

name: Deploy

on:
  push:
    branches: [main, dev]
  workflow_dispatch:
    inputs:
      deploy_infra:
        description: "Force deploy infrastructure"
        type: boolean
        default: false
      deploy_backend:
        description: "Force deploy backend"
        type: boolean
        default: false
      deploy_frontend:
        description: "Force deploy frontend"
        type: boolean
        default: false
      deploy_function:
        description: "Force deploy function"
        type: boolean
        default: false

# ---------------------------------------------------------------------------
# Job: Detect Changes
# ---------------------------------------------------------------------------
jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      infra: ${{ steps.filter.outputs.infra }}
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      function: ${{ steps.filter.outputs.function }}
    steps:
      - uses: actions/checkout@v4

      - name: Determine environment
        id: set-env
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi

      - name: Detect changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            infra:
              - 'infra/**'
            backend:
              - 'backend/**'
              - 'Dockerfile'
            frontend:
              - 'frontend/**'
            function:
              - 'function/**'

  # ---------------------------------------------------------------------------
  # Job: Deploy Infrastructure (Bicep)
  # ---------------------------------------------------------------------------
  deploy-infra:
    name: Infrastructure
    needs: [detect-changes]
    if: >-
      needs.detect-changes.outputs.infra == 'true'
      || (github.event_name == 'workflow_dispatch' && inputs.deploy_infra)
    uses: ./.github/workflows/_deploy-infra.yml
    with:
      environment: ${{ needs.detect-changes.outputs.environment }}
    secrets: inherit
    permissions:
      id-token: write
      contents: read

  # ---------------------------------------------------------------------------
  # Job: Deploy Backend (Docker → GHCR → Container Apps)
  # ---------------------------------------------------------------------------
  deploy-backend:
    name: Backend
    needs: [detect-changes, deploy-infra]
    if: >-
      always() && !failure() && !cancelled()
      && (
        needs.detect-changes.outputs.backend == 'true'
        || needs.detect-changes.outputs.infra == 'true'
        || (github.event_name == 'workflow_dispatch' && inputs.deploy_backend)
      )
    uses: ./.github/workflows/_deploy-backend.yml
    with:
      environment: ${{ needs.detect-changes.outputs.environment }}
    secrets: inherit
    permissions:
      id-token: write
      contents: read
      packages: write

  # ---------------------------------------------------------------------------
  # Job: Deploy Frontend (Build → SWA)
  # ---------------------------------------------------------------------------
  deploy-frontend:
    name: Frontend
    needs: [detect-changes, deploy-infra]
    if: >-
      always() && !failure() && !cancelled()
      && (
        needs.detect-changes.outputs.frontend == 'true'
        || needs.detect-changes.outputs.infra == 'true'
        || (github.event_name == 'workflow_dispatch' && inputs.deploy_frontend)
      )
    uses: ./.github/workflows/_deploy-frontend.yml
    with:
      environment: ${{ needs.detect-changes.outputs.environment }}
    secrets: inherit
    permissions:
      contents: read

  # ---------------------------------------------------------------------------
  # Job: Deploy Azure Functions
  # ---------------------------------------------------------------------------
  deploy-function:
    name: Function
    needs: [detect-changes, deploy-infra]
    if: >-
      always() && !failure() && !cancelled()
      && (
        needs.detect-changes.outputs.function == 'true'
        || needs.detect-changes.outputs.infra == 'true'
        || (github.event_name == 'workflow_dispatch' && inputs.deploy_function)
      )
    uses: ./.github/workflows/_deploy-function.yml
    with:
      environment: ${{ needs.detect-changes.outputs.environment }}
    secrets: inherit
    permissions:
      id-token: write
      contents: read
